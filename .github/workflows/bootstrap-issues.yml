name: Bootstrap Labels + Issue Menu + Milestones

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      force:
        description: "Re-run even if issues/milestones already exist"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap labels, milestones, and issues via GitHub REST API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          FORCE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.force) || 'false' }}
        run: |
          set -euo pipefail

          API_STATUS=""

          # Usage: api METHOD PATH DATA OUTVAR
          api() {
            local method="$1"
            local path="$2"
            local data="${3:-}"
            local outvar="$4"

            local url="https://api.github.com${path}"
            local tmp
            tmp="$(mktemp)"

            if [[ -n "${data}" ]]; then
              API_STATUS="$(curl -sS -o "${tmp}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}" \
                -d "${data}")"
            else
              API_STATUS="$(curl -sS -o "${tmp}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}")"
            fi

            printf -v "${outvar}" '%s' "$(cat "${tmp}")"
            rm -f "${tmp}"
          }

          urlencode() {
            python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=""))' "$1"
          }

          # Skip ONLY if BOTH issues exist AND milestones exist (unless forced)
          any_issues_exist() {
            local q encq resp total
            q="repo:${REPO} is:issue"
            encq="$(python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))' "$q")"

            api GET "/search/issues?q=${encq}&per_page=1" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: search/issues failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi

            total="$(echo "${resp}" | jq -r '.total_count')"
            [[ "${total}" != "0" ]]
          }

          any_milestones_exist() {
            local resp
            api GET "/repos/${REPO}/milestones?state=all&per_page=1" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: milestones list failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
            [[ "$(echo "${resp}" | jq 'length')" != "0" ]]
          }

          ensure_label() {
            local name="$1"
            local color="$2"
            local desc="$3"
            local enc payload patch resp

            enc="$(urlencode "$name")"

            payload="$(jq -n --arg name "$name" --arg color "$color" --arg description "$desc" \
              '{name:$name,color:$color,description:$description}')"

            api POST "/repos/${REPO}/labels" "${payload}" resp
            if [[ "${API_STATUS}" == "201" ]]; then
              echo "Created label: ${name}" >&2
              return 0
            fi

            if [[ "${API_STATUS}" == "422" ]]; then
              patch="$(jq -n --arg new_name "$name" --arg color "$color" --arg description "$desc" \
                '{new_name:$new_name,color:$color,description:$description}')"

              api PATCH "/repos/${REPO}/labels/${enc}" "${patch}" resp
              if [[ "${API_STATUS}" == "200" ]]; then
                echo "Updated label: ${name}" >&2
                return 0
              fi
            fi

            echo "ERROR: ensure_label failed for ${name} (HTTP ${API_STATUS})" >&2
            echo "${resp}" >&2
            exit 1
          }

          milestone_number_by_title() {
            local title="$1"
            local resp num
            api GET "/repos/${REPO}/milestones?state=all&per_page=100" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: milestones list failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
            num="$(echo "${resp}" | jq -r --arg t "${title}" '.[] | select(.title==$t) | .number' | head -n 1)"
            [[ "${num}" == "null" ]] && num=""
            echo "${num}"
          }

          ensure_milestone() {
            local title="$1"
            local description="$2"
            local existing payload resp num

            existing="$(milestone_number_by_title "${title}")"
            if [[ -n "${existing}" ]]; then
              echo "Milestone exists: ${title} (#${existing})" >&2
              echo "${existing}"
              return 0
            fi

            payload="$(jq -n --arg title "$title" --arg description "$description" \
              '{title:$title, description:$description}')"

            api POST "/repos/${REPO}/milestones" "${payload}" resp
            if [[ "${API_STATUS}" != "201" ]]; then
              echo "ERROR: create milestone failed for ${title} (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi

            num="$(echo "${resp}" | jq -r '.number')"
            echo "Created milestone: ${title} (#${num})" >&2
            echo "${num}"
          }

          labels_csv_to_json() {
            local labels_csv="$1"
            printf '%s' "${labels_csv}" \
              | awk -F',' '{for (i=1;i<=NF;i++) print $i}' \
              | sed '/^\s*$/d' \
              | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
              | jq -R . | jq -s .
          }

          # Exact-title lookup by listing issues (avoids Search indexing quirks)
          issue_number_by_title_list() {
            local title="$1"
            local page=1 resp num

            while true; do
              api GET "/repos/${REPO}/issues?state=all&per_page=100&page=${page}" "" resp
              if [[ "${API_STATUS}" != "200" ]]; then
                echo "ERROR: list issues failed (HTTP ${API_STATUS})" >&2
                echo "${resp}" >&2
                exit 1
              fi

              if [[ "$(echo "${resp}" | jq 'length')" == "0" ]]; then
                break
              fi

              num="$(echo "${resp}" | jq -r --arg t "${title}" \
                '.[] | select(.pull_request==null) | select(.title==$t) | .number' | head -n 1)"
              [[ "${num}" == "null" ]] && num=""

              if [[ -n "${num}" ]]; then
                echo "${num}"
                return 0
              fi

              page=$((page + 1))
            done

            echo ""
          }

          ensure_issue() {
            local title="$1"
            local labels_csv="$2"
            local body="$3"

            local existing_num labels_json payload resp num
            existing_num="$(issue_number_by_title_list "${title}")"
            labels_json="$(labels_csv_to_json "${labels_csv}")"

            if [[ -n "${existing_num}" ]]; then
              payload="$(jq -n \
                --arg body "${body}" \
                --argjson labels "${labels_json}" \
                '{body:$body, labels:$labels}')"

              api PATCH "/repos/${REPO}/issues/${existing_num}" "${payload}" resp
              if [[ "${API_STATUS}" != "200" ]]; then
                echo "ERROR: update issue failed (HTTP ${API_STATUS}) for ${title} (#${existing_num})" >&2
                echo "${resp}" >&2
                exit 1
              fi

              echo "Updated issue: ${title} (#${existing_num})" >&2
              echo "${existing_num}"
              return 0
            fi

            payload="$(jq -n \
              --arg title "${title}" \
              --arg body "${body}" \
              --argjson labels "${labels_json}" \
              '{title:$title, body:$body, labels:$labels}')"

            api POST "/repos/${REPO}/issues" "${payload}" resp
            if [[ "${API_STATUS}" != "201" ]]; then
              echo "ERROR: create issue failed (HTTP ${API_STATUS}) for ${title}" >&2
              echo "${resp}" >&2
              exit 1
            fi

            num="$(echo "${resp}" | jq -r '.number')"
            echo "Created issue: ${title} (#${num})" >&2
            echo "${num}"
          }

          assign_issue_to_milestone() {
            local issue_number="$1"
            local milestone_number="$2"
            local payload resp

            payload="$(jq -n --argjson milestone "$milestone_number" '{milestone:$milestone}')"

            api PATCH "/repos/${REPO}/issues/${issue_number}" "${payload}" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: assign milestone failed for issue #${issue_number} (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
          }

          assign_all_existing_issues_to_milestones() {
            local page=1
            while true; do
              local resp
              api GET "/repos/${REPO}/issues?state=all&per_page=100&page=${page}" "" resp
              if [[ "${API_STATUS}" != "200" ]]; then
                echo "ERROR: list issues failed (HTTP ${API_STATUS})" >&2
                echo "${resp}" >&2
                exit 1
              fi

              if [[ "$(echo "${resp}" | jq 'length')" == "0" ]]; then
                break
              fi

              echo "${resp}" | jq -r '.[] | select(.pull_request==null) | "\(.number)\t\(.title)"' \
                | while IFS=$'\t' read -r num title; do
                    local ms=""
                    case "${title}" in
                      "[P1]"*) ms="${MS_P1}" ;;
                      "[P2]"*) ms="${MS_P2}" ;;
                      "[P3]"*) ms="${MS_P3}" ;;
                      "[P4]"*) ms="${MS_P4}" ;;
                      *) ms="" ;;
                    esac

                    if [[ -n "${ms}" ]]; then
                      assign_issue_to_milestone "${num}" "${ms}"
                      echo "Assigned issue #${num} -> milestone #${ms} (${title})" >&2
                    fi
                  done

              page=$((page + 1))
            done
          }

          # Append test-type definitions to EVERY issue so contexts are unambiguous.
          TEST_TYPES=$'---\n### Test type definitions (CSCI 630 standard)\n- **MVC test (Controller slice):** `@WebMvcTest(Controller.class)` + `MockMvc` + `spring-security-test`. No real DB. Mock dependencies using `@MockBean`. Assert: HTTP status + view name (or JSON) + key model attributes + security (anonymous vs `@WithMockUser`) + CSRF where relevant.\n- **Service unit test:** Plain JUnit5 + Mockito (`@ExtendWith(MockitoExtension.class)`). No Spring context. Assert business rules, ownership checks, and repository interactions.\n- **Repository test (JPA slice):** `@DataJpaTest`. Uses an embedded test DB. Course standard: add H2 as a **test** dependency unless the issue explicitly requires Testcontainers.\n- **Integration test (full stack):** `@SpringBootTest` + `@AutoConfigureMockMvc`. Hits real web + services + repositories. Uses embedded DB (H2) unless the issue explicitly requires **Postgres Testcontainers**.\n'

          create_and_assign() {
            local title="$1"
            local labels="$2"
            local body="$3"
            local full_body
            full_body="${body}"$'\n\n'"${TEST_TYPES}"
            ensure_issue "${title}" "${labels}" "${full_body}" >/dev/null
            echo "Ensured issue: ${title}" >&2
          }

          echo "Repo: ${REPO}" >&2
          echo "Force: ${FORCE}" >&2

          if [[ "${FORCE}" != "true" ]]; then
            if any_issues_exist && any_milestones_exist; then
              echo "Repo already has issues AND milestones; skipping bootstrap." >&2
              exit 0
            fi
          fi

          echo "Creating/updating labels..." >&2
          ensure_label "P1" "1f77b4" "Project 1"
          ensure_label "P2" "ff7f0e" "Project 2"
          ensure_label "P3" "2ca02c" "Project 3"
          ensure_label "P4" "d62728" "Project 4"

          ensure_label "size/S" "a1d99b" "Small scope"
          ensure_label "size/M" "74c476" "Medium scope"
          ensure_label "size/L" "238b45" "Large scope"

          ensure_label "type/bug" "e15759" "Bug fix"
          ensure_label "type/refactor" "4e79a7" "Refactoring / design cleanup"
          ensure_label "type/feature" "59a14f" "New feature"
          ensure_label "type/tests" "f28e2b" "Testing work"
          ensure_label "type/devops" "edc949" "DevOps / CI / release"

          ensure_label "area/ui" "76b7b2" "UI / UX"
          ensure_label "area/security" "b07aa1" "Security / auth"
          ensure_label "area/data" "9c755f" "Data model / DB"

          ensure_label "anchor/patterns" "9467bd" "Requires an explicit design pattern application"
          ensure_label "anchor/smells-antipatterns" "8c564b" "Requires identifying and correcting a code smell or anti-pattern"

          echo "Creating/updating milestones in reverse creation order (P4 -> P1)..." >&2
          MS_P4="$(ensure_milestone "P4" "Project 4: DevOps/quality gates + release discipline")"
          MS_P3="$(ensure_milestone "P3" "Project 3: feature work with clean design + tests")"
          MS_P2="$(ensure_milestone "P2" "Project 2: maintainability rescue + larger refactoring")"
          MS_P1="$(ensure_milestone "P1" "Project 1: foundational tests + small refactors/bug fixes")"

          echo "Ensuring issues in reverse creation order (P4 -> P1), and reverse-within-project so newest-first displays in completion order..." >&2

          # =========================
          # P4 (create first; appears lowest when sorting newest)
          # =========================

          create_and_assign "[P4][M] Harden Actuator usage (health/info + security)" "P4,size/M,type/devops,area/security,type/tests" $'## Goal\nConfigure Spring Boot Actuator so only minimal endpoints are exposed, and access is controlled.\n\n## Required work\n1) Configure Actuator exposure to **only** `health` and `info`.\n2) Ensure actuator endpoints are not accidentally public.\n3) Document the intended policy in README (who can access, and why).\n\n## Required tests (Integration; H2 is fine)\nCreate `src/test/java/.../ActuatorSecurityIntegrationTest.java` with:\n1) `anonymous_getHealth_isDenied()`\n   - `GET /actuator/health` as anonymous\n   - assert **401 or 403**\n2) `authenticated_getHealth_isAllowed()`\n   - `@WithMockUser` then `GET /actuator/health`\n   - assert **200**\n\n## Acceptance criteria\n- Only `health` and `info` are exposed.\n- Anonymous access is blocked.\n- Tests pass in CI.'

          create_and_assign "[P4][M] Add structured logging + request correlation IDs + troubleshooting guide" "P4,size/M,type/devops,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Scattered Logging / Observability Gap** (no end-to-end request tracing)\n\n## Pattern (must name in your design note)\n- **Servlet Filter** (or HandlerInterceptor) for cross-cutting concerns\n\n## Required work\n1) Implement a request filter/interceptor that:\n   - if request has header `X-Correlation-Id`, use it\n   - else generate a new correlation id\n   - store it in MDC for logging\n   - always include `X-Correlation-Id` in the response\n2) Update logging pattern to include correlation id.\n3) Add `TROUBLESHOOTING.md` with steps for capturing correlation id and grepping logs.\n\n## Required tests (Integration; H2 is fine)\nCreate `CorrelationIdIntegrationTest.java` with:\n1) `responseContainsCorrelationIdHeader()`\n   - `GET /login` (or `/` if anonymous route)\n   - assert response header `X-Correlation-Id` exists and is non-empty\n2) `clientSuppliedCorrelationIdIsPreserved()`\n   - send header `X-Correlation-Id: test-123`\n   - assert response header equals `test-123`\n\n## Required design note\n- `docs/design-notes/P4-correlation-id.md` must explicitly name the smell and pattern above.\n\n## Acceptance criteria\n- Every HTTP response contains `X-Correlation-Id`.\n- Correlation id is included in logs.\n- Both tests pass.'

          create_and_assign "[P4][M/L] Add Testcontainers-based integration tests for repositories" "P4,size/M,type/tests,type/devops,area/data" $'## Goal\nAdd Postgres Testcontainers integration tests so repository behavior is validated against real Postgres.\n\n## Required work\n1) Add Testcontainers dependencies and configuration.\n2) Ensure tests start a Postgres container automatically.\n\n## Required tests (Integration; MUST use Postgres Testcontainers)\nCreate `RepositoryContainerIntegrationTest.java` with:\n1) `transactionRepository_queryByUser_returnsOnlyThatUser()`\n   - persist 2 users worth of transactions\n   - call the repository method used by the app (e.g., `findByUserId(...)`)\n   - assert only that user’s rows are returned\n2) `incomeRepository_queryByUser_returnsOnlyThatUser()`\n   - same structure for incomes\n\n## Acceptance criteria\n- Tests run in CI reliably.\n- Tests use Postgres Testcontainers (not H2).\n- Both tests pass.'

          create_and_assign "[P4][L] Introduce Flyway migrations and stop using ddl-auto=update" "P4,size/L,type/devops,type/tests,area/data" $'## Goal\nReplace schema drift with repeatable migrations.\n\n## Required work\n1) Add Flyway.\n2) Create baseline migration(s) matching current schema.\n3) Set `spring.jpa.hibernate.ddl-auto` to **validate** (or none) for non-dev.\n\n## Required tests (Integration; MUST use Postgres Testcontainers)\nCreate `FlywayBootstrapIntegrationTest.java` with:\n1) `bootsOnEmptyDatabase_andCreatesSchema()`\n   - start Postgres Testcontainer\n   - start Spring context pointing to the container\n   - assert context loads and at least one repository call works (e.g., `userRepository.count()`)\n\n## Acceptance criteria\n- App boots cleanly on an empty Postgres DB.\n- Flyway runs automatically.\n- Test passes in CI.'

          create_and_assign "[P4][M] Add Docker Compose for local run (app + Postgres) + docs" "P4,size/M,type/devops,type/tests" $'## Goal\nMake local setup reproducible with one command.\n\n## Required work\n1) Add `docker-compose.yml` to run:\n   - Postgres\n   - the app\n2) Use environment variables (no secrets committed).\n3) Update README with:\n   - `docker compose up --build`\n   - expected URL(s)\n   - how to reset DB volume\n\n## Required automated check (GitHub Actions)\nAdd a workflow job named `compose-smoke` that:\n1) runs `docker compose up -d --build`\n2) waits for the app port\n3) curls `GET /login` expecting **200**\n4) runs `docker compose down -v`\n\n## Acceptance criteria\n- Compose works locally.\n- `compose-smoke` job runs and passes in CI.'

          create_and_assign "[P4][M] Add CI pipeline with required checks (tests + formatting)" "P4,size/M,type/devops,type/tests" $'## Goal\nMake quality gates enforced by CI.\n\n## Required work\n1) Add a GitHub Actions workflow that runs on PR.\n2) Workflow must include two jobs:\n   - `unit-tests`: runs `mvn test`\n   - `quality-gate`: runs ONE of Spotless OR Checkstyle OR SpotBugs\n\n## Required verification\nOpen a PR and confirm both checks appear and must pass before merge.\n\n## Acceptance criteria\n- CI runs on PR.\n- Both jobs execute and fail when appropriate.\n- README documents local equivalents.'

          # =========================
          # P3
          # =========================

          create_and_assign "[P3][L] Split a transaction across multiple categories" "P3,size/L,type/feature,type/tests,area/data" $'## Goal\nAllow one transaction to be split into multiple category line items.\n\n## Required work\n1) Add a split/line-item model so each line has (category, amount).\n2) UI supports adding/removing split lines.\n3) Enforce invariant: sum(line amounts) == transaction total.\n4) Totals/charts must use split lines for category totals.\n\n## Required tests\nCreate:\n- `SplitTransactionServiceTest.java` (unit)\n- `SplitTransactionRepositoryTest.java` (JPA)\n\nMust implement these tests:\n1) `rejectsWhenSplitSumDoesNotEqualTotal()` (unit)\n2) `persistsAndLoadsLineItems()` (JPA)\n3) `categoryTotalsUseSplitLines()` (unit)\n\n## Acceptance criteria\n- Invariant enforced.\n- Category totals reflect split lines.\n- All 3 tests pass.'

          create_and_assign "[P3][L] CSV import with preview + validation report" "P3,size/L,type/feature,type/tests,area/data" $'## Goal\nImport transactions from CSV with a preview step and validation report.\n\n## Required work\n1) Upload CSV -> preview page showing parsed rows.\n2) Preview page must show per-row validation errors with row numbers.\n3) Only after explicit confirmation should records be persisted.\n\n## Required tests (Integration; H2 is fine)\nCreate `CsvImportIntegrationTest.java` with:\n1) `upload_showsPreviewWithParsedRows()`\n2) `preview_showsValidationErrorsForBadRows()`\n3) `confirm_persistsRecords_afterConfirmationOnly()`\n\n## Acceptance criteria\n- Preview step exists.\n- Validation report is clear.\n- Persist happens only after confirmation.\n- All 3 tests pass.'

          create_and_assign "[P3][L] Recurring income/expense rules" "P3,size/L,type/feature,type/tests,area/data" $'## Goal\nSupport recurring rules and safe generation of future instances.\n\n## Required work\n1) Add recurrence rule entity (weekly/monthly).\n2) Generate instances up to a fixed horizon (e.g., next 3 months).\n3) Generation must be idempotent (no duplicates on rerun).\n4) Define and implement a month-end policy (e.g., Jan 31 -> Feb 28/29).\n\n## Required tests (Service unit)\nCreate `RecurrenceGeneratorTest.java` with:\n1) `generatesExpectedInstancesWithinHorizon()`\n2) `rerunIsIdempotent_noDuplicates()`\n3) `monthEndRule_isCorrect()`\n\n## Acceptance criteria\n- No duplicates.\n- Month-end behavior correct.\n- All 3 tests pass.'

          create_and_assign "[P3][L] Implement monthly budgets per category" "P3,size/L,type/feature,type/tests,area/data" $'## Goal\nAllow users to set monthly budgets per category and see remaining/over-budget.\n\n## Required work\n1) Add `CategoryBudget(user, yearMonth, category, amount)`.\n2) UI to create/update budgets for a month.\n3) Dashboard must show spent vs budget and remaining/over for each category.\n\n## Required tests\nCreate:\n- `BudgetCalculationTest.java` (unit)\n- `CategoryBudgetRepositoryTest.java` (JPA)\n\nMust implement:\n1) `underBudget_remainingCorrect()` (unit)\n2) `overBudget_excessCorrect()` (unit)\n3) `budgetPersistsForUserMonthCategory()` (JPA)\n\n## Acceptance criteria\n- Calculations correct.\n- Persistence works.\n- All 3 tests pass.'

          create_and_assign "[P3][M/L] Add a small REST API (read-only) for transactions + incomes" "P3,size/M,type/feature,type/tests,area/security,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Expose Entities / Leaky Abstraction** (serializing JPA entities directly)\n\n## Pattern (must name in your design note)\n- **DTO + Mapper/Assembler** (explicit boundary mapping)\n\n## Required work\n1) Implement endpoints:\n   - `GET /api/transactions`\n   - `GET /api/incomes`\n2) Do NOT serialize entities directly. Return DTOs.\n3) Must return ONLY logged-in user’s data.\n\n## Required tests (Integration; H2 is fine)\nCreate `ApiSecurityIntegrationTest.java` with:\n1) `anonymous_apiIsDenied()`\n   - `GET /api/transactions` as anonymous -> assert **401/403**\n2) `authenticated_onlyOwnDataReturned()`\n   - create data for two users\n   - request as user A\n   - assert response contains only user A data\n\n## Required design note\n- `docs/design-notes/P3-api-dto-boundary.md`\n\n## Acceptance criteria\n- DTO boundary exists.\n- Security scoping correct.\n- Both tests pass.'

          create_and_assign "[P3][M] Add “notes” field and display it everywhere relevant" "P3,size/M,type/feature,type/tests,area/ui" $'## Goal\nAdd a notes field and ensure it is persisted and rendered.\n\n## Required work\n1) Add `notes` field to Transaction.\n2) Show notes in list/detail/edit views.\n3) Include notes in CSV export.\n\n## Required tests\nCreate:\n- `TransactionRepositoryNotesTest.java` (JPA)\n- `NotesRenderingMvcTest.java` (MVC)\n\nMust implement:\n1) `notes_persistAndLoad()` (JPA)\n2) `notes_areRenderedInHtml()` (MVC)\n\n## Acceptance criteria\n- Notes persist.\n- Notes appear in HTML.\n- Both tests pass.'

          create_and_assign "[P3][M] Add pagination for transactions and incomes" "P3,size/M,type/feature,type/tests,area/ui" $'## Goal\nAdd pagination and keep stable newest-first ordering.\n\n## Required work\n1) Convert list queries to `Pageable`.\n2) UI must include next/prev controls and current page indicator.\n3) Default sort must remain date desc.\n\n## Required tests (Repository; JPA slice)\nCreate `PaginationRepositoryTest.java` with:\n1) `transactions_pageSizeAndTotalCorrect()`\n2) `transactions_sortedByDateDescAcrossPages()`\n\n## Acceptance criteria\n- Pagination works.\n- Sort stable.\n- Both tests pass.'

          create_and_assign "[P3][M] Add filters: date range + category + text search" "P3,size/M,type/feature,type/tests,area/ui,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Conditional Query Explosion / Long Parameter List**\n\n## Pattern (must name in your design note)\n- **Specification Pattern** (Spring Data JPA Specifications)\n\n## Required work\n1) Implement filters using Spring Data JPA Specifications.\n2) Filters must combine (date range + category + text) without creating many repository methods.\n3) UI must allow setting all filters.\n\n## Required tests (Repository; JPA slice)\nCreate `TransactionSpecificationTest.java` with:\n1) `filter_dateRangeAndCategory()`\n2) `filter_categoryAndText()`\n3) `filter_allCombined()`\n\n## Required design note\n- `docs/design-notes/P3-filter-specification.md`\n\n## Acceptance criteria\n- Filter composition correct.\n- Exactly 3 tests above pass.'

          # =========================
          # P2
          # =========================

          create_and_assign "[P2][L] Introduce a shared base entity for Income and Transaction" "P2,size/L,type/refactor,type/tests,area/data" $'## Goal\nReduce duplicated entity mapping while keeping persistence correct.\n\n## Required work\n1) Introduce a `@MappedSuperclass` for shared fields.\n2) Refactor Income and Transaction to inherit.\n\n## Required tests (Repository; JPA slice)\nCreate:\n- `TransactionMappingJpaTest.java`\n- `IncomeMappingJpaTest.java`\n\nMust implement:\n1) `transaction_persistFlushClearReload_roundTripsFields()`\n2) `income_persistFlushClearReload_roundTripsFields()`\n\n## Acceptance criteria\n- Mapping works after refactor.\n- Both tests pass.'

          create_and_assign "[P2][L] Replace double amounts with BigDecimal (money correctness)" "P2,size/L,type/refactor,type/tests,area/data,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Primitive Obsession** (money as primitive) and floating-point rounding errors\n\n## Pattern (must name in your design note)\n- **Value Object** (Money)\n\n## Required work\n1) Replace money fields with BigDecimal.\n2) Introduce a Money value object (wrapper) that centralizes scale and rounding.\n3) Update totals, charts, and export to use Money.\n\n## Required tests (Unit)\nCreate `MoneyValueObjectTest.java` with:\n1) `addsWithFixedScale()`\n2) `classicFloatingPointExample_isCorrect()`\n\nCreate `CashflowTotalsWithMoneyTest.java` with:\n3) `summaryTotals_useMoneyAndAreCorrect()`\n\n## Required design note\n- `docs/design-notes/P2-money-value-object.md`\n\n## Acceptance criteria\n- No doubles used for money.\n- All 3 tests pass.'

          create_and_assign "[P2][S] Make DataSeeder run only in dev profile" "P2,size/S,type/refactor,type/tests" $'## Goal\nEnsure DataSeeder does not run in tests or normal runs.\n\n## Required work\n1) Add `@Profile(\"dev\")` (or equivalent) to DataSeeder.\n2) Ensure seeding is disabled by default.\n\n## Required tests (Integration; H2 is fine)\nCreate `SeederProfileIntegrationTest.java` with:\n1) `defaultProfile_dataSeederBeanIsAbsent()`\n   - assert application context does NOT contain `DataSeeder`\n2) `devProfile_dataSeederBeanIsPresent()`\n   - start context with `spring.profiles.active=dev`\n   - assert context DOES contain `DataSeeder`\n\n## Acceptance criteria\n- Seeder is dev-only.\n- Both tests pass.'

          create_and_assign "[P2][M] Enforce unique usernames + improve registration validation" "P2,size/M,type/feature,type/tests,area/security" $'## Goal\nPrevent duplicate usernames and show a friendly error.\n\n## Required work\n1) Add a DB uniqueness constraint to username.\n2) Update registration flow so duplicates show an in-form error.\n\n## Required tests\nCreate `UserRepositoryUniqueUsernameTest.java` (JPA) with:\n1) `username_isUniqueConstraint()`\n\nCreate `RegistrationDuplicateUsernameMvcTest.java` (MVC) with:\n2) `duplicateUsername_showsErrorAndDoesNotRedirect()`\n\n## Acceptance criteria\n- Constraint enforced.\n- UI error shown.\n- Both tests pass.'

          create_and_assign "[P2][M] Add @ControllerAdvice for consistent error handling" "P2,size/M,type/refactor,type/tests" $'## Goal\nCentralize error handling for consistent, friendly responses.\n\n## Required work\n1) Add `@ControllerAdvice` that handles:\n   - not found\n   - generic exception\n2) Return a friendly error page without stack traces.\n\n## Required tests (MVC)\nCreate `GlobalErrorHandlerMvcTest.java` with:\n1) `notFound_returnsFriendlyErrorView()`\n2) `unhandledException_returnsFriendlyErrorView()`\n\n## Acceptance criteria\n- Errors are consistent.\n- Both tests pass.'

          create_and_assign "[P2][M] Replace “Month = now” with a PeriodStrategy" "P2,size/M,type/refactor,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Conditional Complexity** (period logic scattered as if/else)\n\n## Pattern (must name in your design note)\n- **Strategy Pattern** (`PeriodStrategy`)\n\n## Required work\n1) Create `PeriodStrategy` returning a date range.\n2) Implement:\n   - `CurrentMonthStrategy`\n   - `SelectedMonthStrategy` (from `?month=YYYY-MM`)\n3) Update dashboard/home summary code to use strategy output.\n\n## Required tests (Unit)\nCreate `PeriodStrategyTest.java` with:\n1) `currentMonth_rangeCorrect()`\n2) `selectedMonth_rangeCorrect_forYYYYMM()`\n\n## Required design note\n- `docs/design-notes/P2-period-strategy.md`\n\n## Acceptance criteria\n- Period selection is strategy-based.\n- Both tests pass.'

          create_and_assign "[P2][M] Deduplicate monthly summary calculations (home + dashboard)" "P2,size/M,type/refactor,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Duplicate Code / Shotgun Surgery** (same totals computed in multiple places)\n\n## Pattern (must name in your design note)\n- **Facade** (`CashflowSummaryService`) returning a **Value Object** summary\n\n## Required work\n1) Create `CashflowSummaryService` as the single entry point to compute totals.\n2) Create a summary value object (e.g., `MonthlyCashflowSummary`).\n3) Update both home + dashboard to use the facade.\n\n## Required tests (Service unit)\nCreate `CashflowSummaryServiceTest.java` with:\n1) `emptyData_totalsAreZero()`\n2) `mixedData_totalsCorrect()`\n3) `ignoresRecordsOutsideSelectedMonth()`\n\n## Required design note\n- `docs/design-notes/P2-summary-facade.md`\n\n## Acceptance criteria\n- Duplicate computations removed.\n- All 3 tests pass.'

          create_and_assign "[P2][M] Introduce service layer for transactions/incomes (thin controllers)" "P2,size/M,type/refactor,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **God Controller / Transaction Script**\n\n## Pattern (must name in your design note)\n- **Service Layer** (explicit boundary)\n\n## Required work\n1) Create `TransactionService` and `IncomeService`.\n2) Move ownership checks + user scoping into services.\n3) Controllers become orchestration only.\n\n## Required tests (Service unit)\nCreate:\n- `TransactionServiceTest.java`\n- `IncomeServiceTest.java`\n\nMust implement:\n1) `createTransaction_happyPath_saves()`\n2) `deleteTransaction_wrongOwner_isRejected()`\n3) `listIncomes_scopedToUserOnly()`\n\n## Required design note\n- `docs/design-notes/P2-service-layer.md`\n\n## Acceptance criteria\n- Controllers are thin.\n- Services enforce ownership.\n- All 3 tests pass.'

          # =========================
          # P1 (create last; appears on top when sorting newest)
          # =========================

          create_and_assign "[P1][S] Add “empty state” UI for new users" "P1,size/S,type/feature,area/ui" $'## Goal\nImprove UX when the user has no incomes/transactions.\n\n## Required work\n1) Update `home.html` so when there are 0 transactions and 0 incomes:\n   - show a visible empty-state section containing the exact text: `Add your first transaction`\n   - show a visible empty-state section containing the exact text: `Add your first income`\n2) Ensure totals and charts do not throw errors on empty datasets.\n\n## Required tests (MVC)\nCreate `HomeEmptyStateMvcTest.java` with:\n1) `authenticated_noData_rendersHome()`\n   - `@WithMockUser`\n   - `GET /` -> status 200, view `home`\n2) `authenticated_noData_containsEmptyStateMarkers()`\n   - assert response body contains both required strings\n\n## Acceptance criteria\n- Empty state text appears exactly as specified.\n- Both tests pass.'

          create_and_assign "[P1][S] Sort transactions and incomes by date (newest first)" "P1,size/S,type/refactor,area/ui" $'## Goal\nEnsure lists are newest-first and the controller uses repository methods that encode the ordering.\n\n## Required work\n1) Add repository methods:\n   - `TransactionRepository.findByUserIdOrderByDateDesc(Long userId)`\n   - `IncomeRepository.findByUserIdOrderByDateDesc(Long userId)`\n2) Update controller to call those methods (not unsorted `findByUserId`).\n\n## Required tests (MVC)\nCreate `SortedListsMvcTest.java` with:\n1) `home_usesOrderedRepositories()`\n   - `@WithMockUser`\n   - verify (Mockito) that controller calls `findByUserIdOrderByDateDesc(...)` for both repos\n2) `home_modelListsAreInExpectedOrder()`\n   - stub ordered lists from mocks\n   - `GET /` -> assert model attribute `transactions` and `incomeList` preserve that order\n\n## Acceptance criteria\n- Controller uses the ordered repository methods.\n- Both tests pass.'

          create_and_assign "[P1][S] Make static assets accessible on landing/login pages" "P1,size/S,type/bug,area/security" $'## Goal\nFix security config so public pages can load the real CSS path used by this repo.\n\n## Required work\n1) Update security configuration to allow anonymous access to:\n   - `/style.css`\n2) Do not weaken protection of authenticated routes.\n\n## Required tests (MVC)\nCreate `StaticAssetsSecurityMvcTest.java` with:\n1) `anonymous_canGetStyleCss()`\n   - anonymous `GET /style.css` -> status 200 and content-type starts with `text/css`\n2) `anonymous_canViewLoginPage()`\n   - anonymous `GET /login` -> status 200\n\n## Acceptance criteria\n- `/style.css` loads anonymously.\n- Both tests pass.'

          create_and_assign "[P1][S] Fix `/dashboard` route (missing view)" "P1,size/S,type/bug,type/tests,area/ui" $'## Goal\nMake `/dashboard` a real, working page.\n\n## Required work\n1) Create `src/main/resources/templates/dashboard.html`.\n2) The page must render and display the values already placed in the model by the controller:\n   - `monthlyTotal`\n   - `totalEarnings`\n   - `netCashflow`\n3) Add a visible heading containing the exact text: `Dashboard`.\n\n## Required tests (MVC)\nCreate `DashboardMvcTest.java` with:\n1) `authenticated_getDashboard_returnsDashboardView()`\n   - `@WithMockUser`\n   - `GET /dashboard` -> status 200, view `dashboard`\n2) `authenticated_getDashboard_includesRequiredModelAttributes()`\n   - assert model has `monthlyTotal`, `totalEarnings`, `netCashflow`\n\n## Acceptance criteria\n- Dashboard template exists and renders.\n- Both tests pass.'

          create_and_assign "[P1][M] Improve CSV export: consistent quoting + file name includes date" "P1,size/M,type/feature,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Ad-hoc String Building** (fragile CSV formatting scattered in controller)\n\n## Pattern (must name in your design note)\n- **Strategy Pattern** for cell escaping/quoting rules\n\n## Required work\n1) Extract CSV escaping/quoting into a `CsvEscaper` strategy.\n2) Ensure output correctly handles:\n   - commas\n   - quotes\n   - newlines\n3) Set `Content-Disposition` filename to `transactions-YYYY-MM.csv`.\n\n## Required tests (MVC)\nCreate `CsvExportMvcTest.java` with:\n1) `export_escapesCommasQuotesNewlines()`\n   - mock a transaction with description containing comma + quote + newline\n   - `@WithMockUser` then `GET /export`\n   - assert response body contains a correctly quoted CSV line (must verify escaping behavior)\n2) `export_setsFilenameWithYearMonth()`\n   - assert `Content-Disposition` header contains `transactions-` and matches `YYYY-MM`\n\n## Required design note\n- `docs/design-notes/P1-csv-export.md`\n\n## Acceptance criteria\n- CSV escaping is correct.\n- Filename includes year-month.\n- Both tests pass.'

          create_and_assign "[P1][M] Fix/clarify CSRF behavior for AJAX delete endpoints" "P1,size/M,type/bug,area/security,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **\"Just disable CSRF\"** security anti-pattern\n\n## Pattern (must name in your design note)\n- **Synchronizer Token Pattern** (Spring Security CSRF token)\n\n## Required work\n1) Ensure AJAX delete endpoints work with CSRF enabled:\n   - `POST /transaction/delete/{id}`\n   - `POST /income/delete/{id}`\n2) Implement CSRF token propagation in the UI and include token in the AJAX request.\n\n## Required tests (MVC)\nCreate `CsrfDeleteMvcTest.java` with:\n1) `deleteTransaction_withoutCsrf_isForbidden()`\n   - `@WithMockUser`\n   - POST `/transaction/delete/{id}` without csrf -> status 403\n2) `deleteTransaction_withCsrf_isOk_andDeletes()`\n   - stub repository findById to return a transaction owned by logged-in user\n   - POST with `.with(csrf())` -> status 200\n   - verify `transactionRepository.deleteById(id)` called\n\n## Required design note\n- `docs/design-notes/P1-csrf.md`\n\n## Acceptance criteria\n- CSRF remains enabled.\n- Both tests pass.'

          create_and_assign "[P1][M] Add bean validation to Transaction and Income + show errors in UI" "P1,size/M,type/feature,type/tests,anchor/patterns,anchor/smells-antipatterns" $'## Smell / anti-pattern (must name in your design note)\n- **Missing Validation / Invariants Not Enforced**\n\n## Pattern (must name in your design note)\n- **Command Object** (Form/DTO separate from entity)\n\n## Required work\n1) Create form objects (e.g., `TransactionForm`, `IncomeForm`) with Bean Validation annotations.\n2) Update controllers to use `@Valid` + `BindingResult`.\n3) On validation failure:\n   - return the same view (status 200)\n   - show field-level errors\n   - preserve user-entered values\n\n## Required tests (MVC)\nCreate `ValidationMvcTest.java` with:\n1) `invalidTransaction_showsFieldErrors_andDoesNotSave()`\n   - POST invalid values\n   - expect status 200\n   - assert field errors\n   - verify `transactionRepository.save(...)` is NOT called\n2) `validTransaction_redirects_andSaves()`\n   - POST valid values\n   - expect redirect (3xx)\n   - verify `transactionRepository.save(...)` called once\n\n## Required design note\n- `docs/design-notes/P1-validation.md`\n\n## Acceptance criteria\n- Validation enforced.\n- Both tests pass.'

          create_and_assign "[P1][M] Add first meaningful tests for TransactionController#home" "P1,size/M,type/tests" $'## Goal\nCreate the first reliable MVC tests for core home behavior.\n\n## Required tests (MVC)\nCreate `TransactionControllerMvcTest.java` with exactly these tests:\n1) `anonymousUser_getHome_returnsLanding()`\n   - anonymous `GET /` -> status 200, view `landing`\n2) `authenticatedUser_getHome_returnsHomeAndModelKeys()`\n   - `@WithMockUser`\n   - `GET /` -> status 200, view `home`\n   - assert model contains attributes:\n     - `transactions`\n     - `incomeList`\n     - `monthlyTotal` (or equivalent total used by the view)\n\n## Acceptance criteria\n- Both tests pass in CI.\n- Tests use `@WebMvcTest(TransactionController.class)` and `MockMvc`.'

          echo "Assigning milestones to ALL issues by [P#] prefix..." >&2
          assign_all_existing_issues_to_milestones

          echo "Done." >&2

name: Bootstrap Labels + Issue Menu + Milestones

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      force:
        description: "Re-run even if labels/issues/milestones already exist"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap labels, milestones, and issues via GitHub REST API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          FORCE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.force) || 'false' }}
        run: |
          set -euo pipefail

          API_STATUS=""

          # Usage: api METHOD PATH DATA OUTVAR
          api() {
            local method="$1"
            local path="$2"
            local data="${3:-}"
            local outvar="$4"

            local url="https://api.github.com${path}"
            local tmp
            tmp="$(mktemp)"

            if [[ -n "${data}" ]]; then
              API_STATUS="$(curl -sS -o "${tmp}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}" \
                -d "${data}")"
            else
              API_STATUS="$(curl -sS -o "${tmp}" -w "%{http_code}" \
                -X "${method}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "${url}")"
            fi

            printf -v "${outvar}" '%s' "$(cat "${tmp}")"
            rm -f "${tmp}"
          }

          urlencode() {
            python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=""))' "$1"
          }

          # ---------- Guard helpers (skip only if BOTH exist) ----------

          any_issues_exist() {
            local q encq resp total
            q="repo:${REPO} is:issue"
            encq="$(python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))' "$q")"

            api GET "/search/issues?q=${encq}&per_page=1" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: search/issues failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi

            total="$(echo "${resp}" | jq -r '.total_count')"
            [[ "${total}" != "0" ]]
          }

          any_milestones_exist() {
            local resp
            api GET "/repos/${REPO}/milestones?state=all&per_page=1" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: milestones list failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
            [[ "$(echo "${resp}" | jq 'length')" != "0" ]]
          }

          # ---------- Labels ----------

          ensure_label() {
            local name="$1"
            local color="$2"
            local desc="$3"
            local enc payload patch resp

            enc="$(urlencode "$name")"

            payload="$(jq -n --arg name "$name" --arg color "$color" --arg description "$desc" \
              '{name:$name,color:$color,description:$description}')"

            api POST "/repos/${REPO}/labels" "${payload}" resp
            if [[ "${API_STATUS}" == "201" ]]; then
              echo "Created label: ${name}" >&2
              return 0
            fi

            if [[ "${API_STATUS}" == "422" ]]; then
              patch="$(jq -n --arg new_name "$name" --arg color "$color" --arg description "$desc" \
                '{new_name:$new_name,color:$color,description:$description}')"

              api PATCH "/repos/${REPO}/labels/${enc}" "${patch}" resp
              if [[ "${API_STATUS}" == "200" ]]; then
                echo "Updated label: ${name}" >&2
                return 0
              fi
            fi

            echo "ERROR: ensure_label failed for ${name} (HTTP ${API_STATUS})" >&2
            echo "${resp}" >&2
            exit 1
          }

          # ---------- Milestones ----------

          milestone_number_by_title() {
            local title="$1"
            local resp num
            api GET "/repos/${REPO}/milestones?state=all&per_page=100" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: milestones list failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
            num="$(echo "${resp}" | jq -r --arg t "${title}" '.[] | select(.title==$t) | .number' | head -n 1)"
            [[ "${num}" == "null" ]] && num=""
            echo "${num}"
          }

          ensure_milestone() {
            local title="$1"
            local description="$2"
            local existing payload resp num

            existing="$(milestone_number_by_title "${title}")"
            if [[ -n "${existing}" ]]; then
              echo "Milestone exists: ${title} (#${existing})" >&2
              echo "${existing}"
              return 0
            fi

            payload="$(jq -n --arg title "$title" --arg description "$description" \
              '{title:$title, description:$description}')"

            api POST "/repos/${REPO}/milestones" "${payload}" resp
            if [[ "${API_STATUS}" != "201" ]]; then
              echo "ERROR: create milestone failed for ${title} (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi

            num="$(echo "${resp}" | jq -r '.number')"
            echo "Created milestone: ${title} (#${num})" >&2
            echo "${num}"
          }

          # ---------- Issues ----------

          # Search-based exact title lookup (used for upsert only; may be eventually consistent)
          issue_number_by_title_exact() {
            local title="$1"
            local q encq resp num
            q="repo:${REPO} is:issue in:title \"${title}\""
            encq="$(python3 -c 'import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))' "$q")"

            api GET "/search/issues?q=${encq}&per_page=50" "" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: search/issues failed (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi

            num="$(echo "${resp}" | jq -r --arg t "${title}" '.items[] | select(.title==$t) | select(.pull_request==null) | .number' | head -n 1)"
            [[ "${num}" == "null" ]] && num=""
            echo "${num}"
          }

          upsert_issue() {
            local title="$1"
            local labels_csv="$2"
            local body="$3"

            local existing_num labels_json payload resp num
            existing_num="$(issue_number_by_title_exact "${title}")"

            if [[ -n "${existing_num}" ]]; then
              echo "Skipping existing issue: ${title} (#${existing_num})" >&2
              echo "${existing_num}"
              return 0
            fi

            labels_json="$(printf '%s' "${labels_csv}" \
              | awk -F',' '{for (i=1;i<=NF;i++) print $i}' \
              | sed '/^\s*$/d' \
              | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
              | jq -R . | jq -s .)"

            payload="$(jq -n \
              --arg title "${title}" \
              --arg body "${body}" \
              --argjson labels "${labels_json}" \
              '{title:$title, body:$body, labels:$labels}')"

            api POST "/repos/${REPO}/issues" "${payload}" resp
            if [[ "${API_STATUS}" != "201" ]]; then
              echo "ERROR: create_issue failed (HTTP ${API_STATUS}) for ${title}" >&2
              echo "${resp}" >&2
              exit 1
            fi

            num="$(echo "${resp}" | jq -r '.number')"
            echo "Created issue: ${title} (#${num})" >&2
            echo "${num}"
          }

          assign_issue_to_milestone() {
            local issue_number="$1"
            local milestone_number="$2"
            local payload resp

            payload="$(jq -n --argjson milestone "$milestone_number" '{milestone:$milestone}')"

            api PATCH "/repos/${REPO}/issues/${issue_number}" "${payload}" resp
            if [[ "${API_STATUS}" != "200" ]]; then
              echo "ERROR: assign milestone failed for issue #${issue_number} (HTTP ${API_STATUS})" >&2
              echo "${resp}" >&2
              exit 1
            fi
          }

          # IMPORTANT: list issues via /issues API (not search) and assign by prefix.
          # This is the reliable "fix everything" assignment pass.
          assign_all_existing_issues_to_milestones() {
            local page=1
            while true; do
              local resp
              api GET "/repos/${REPO}/issues?state=all&per_page=100&page=${page}" "" resp
              if [[ "${API_STATUS}" != "200" ]]; then
                echo "ERROR: list issues failed (HTTP ${API_STATUS})" >&2
                echo "${resp}" >&2
                exit 1
              fi

              if [[ "$(echo "${resp}" | jq 'length')" == "0" ]]; then
                break
              fi

              echo "${resp}" | jq -r '.[] | select(.pull_request==null) | "\(.number)\t\(.title)"' \
                | while IFS=$'\t' read -r num title; do
                    local ms=""
                    case "${title}" in
                      "[P1]"*) ms="${MS_P1}" ;;
                      "[P2]"*) ms="${MS_P2}" ;;
                      "[P3]"*) ms="${MS_P3}" ;;
                      "[P4]"*) ms="${MS_P4}" ;;
                      *) ms="" ;;
                    esac

                    if [[ -n "${ms}" ]]; then
                      assign_issue_to_milestone "${num}" "${ms}"
                      echo "Assigned issue #${num} -> milestone #${ms} (${title})" >&2
                    fi
                  done

              page=$((page + 1))
            done
          }

          create_and_assign() {
            local title="$1"
            local labels="$2"
            local body="$3"
            local num

            num="$(upsert_issue "${title}" "${labels}" "${body}")"
            # Don't rely on title matching here; final assignment pass will handle it.
            # (Still safe to do nothing here.)
            echo "Upserted issue #${num} for ${title}" >&2
          }

          echo "Repo: ${REPO}" >&2
          echo "Force: ${FORCE}" >&2

          # Skip ONLY if BOTH issues exist AND milestones exist (unless forced).
          if [[ "${FORCE}" != "true" ]]; then
            if any_issues_exist && any_milestones_exist; then
              echo "Repo already has issues AND milestones; skipping bootstrap." >&2
              exit 0
            fi
          fi

          echo "Creating/updating labels..." >&2
          ensure_label "P1" "1f77b4" "Project 1"
          ensure_label "P2" "ff7f0e" "Project 2"
          ensure_label "P3" "2ca02c" "Project 3"
          ensure_label "P4" "d62728" "Project 4"

          ensure_label "size/S" "a1d99b" "Small scope"
          ensure_label "size/M" "74c476" "Medium scope"
          ensure_label "size/L" "238b45" "Large scope"

          ensure_label "type/bug" "e15759" "Bug fix"
          ensure_label "type/refactor" "4e79a7" "Refactoring / design cleanup"
          ensure_label "type/feature" "59a14f" "New feature"
          ensure_label "type/tests" "f28e2b" "Testing work"
          ensure_label "type/devops" "edc949" "DevOps / CI / release"

          ensure_label "area/ui" "76b7b2" "UI / UX"
          ensure_label "area/security" "b07aa1" "Security / auth"
          ensure_label "area/data" "9c755f" "Data model / DB"

          echo "Creating/updating milestones..." >&2
          MS_P1="$(ensure_milestone "P1" "Project 1: foundational tests + small refactors/bug fixes")"
          MS_P2="$(ensure_milestone "P2" "Project 2: maintainability rescue + larger refactoring")"
          MS_P3="$(ensure_milestone "P3" "Project 3: feature work with clean design + tests")"
          MS_P4="$(ensure_milestone "P4" "Project 4: DevOps/quality gates + release discipline")"

          echo "Creating issues (if missing)..." >&2

          # --- 30 issues ---
          create_and_assign "[P1][S] Fix \`/dashboard\` route (missing view)" "P1,size/S,type/bug,area/ui" $'Problem: Controller has `@GetMapping("/dashboard")` but no `dashboard.html` template.\n\nAcceptance criteria\n- Visiting `/dashboard` while logged in returns a valid page (either create `dashboard.html` or remove/redirect route).\n- Add at least one MVC test proving the behavior.\n\nNotes\n- If you keep it: reuse model attributes already computed in controller.'
          create_and_assign "[P1][S] Make static assets accessible on landing/login pages" "P1,size/S,type/bug,area/security" $'Problem: Security config permits `/css/**` and `/js/**`, but the repo uses `src/main/resources/static/style.css` (served at `/style.css`).\n\nAcceptance criteria\n- Landing + login pages load CSS without authentication.\n- Add a test (or document manual verification) showing unauthenticated access to the CSS path.\n\nHint\n- Update `requestMatchers(...)` to permit the actual static paths used.'
          create_and_assign "[P1][S] Sort transactions and incomes by date (newest first)" "P1,size/S,type/refactor" $'Acceptance criteria\n- Home page shows newest-first ordering for both transactions and incomes.\n- Use repository methods (e.g., `findByUserIdOrderByDateDesc`) instead of sorting in the view.\n- Add a unit test or repository test for ordering.'
          create_and_assign "[P1][S] Add “empty state” UI for new users" "P1,size/S,type/feature,area/ui" $'Acceptance criteria\n- If there are no transactions/incomes, show friendly empty-state cards (“Add your first income/transaction”).\n- No broken charts (Chart.js should not throw on empty datasets).'
          create_and_assign "[P1][M] Add bean validation to \`Transaction\` and \`Income\` + show errors in UI" "P1,size/M,type/feature,type/tests" $'Acceptance criteria\n- Add validation annotations (e.g., required title, amount > 0, date required).\n- Update controller methods to use `@Valid` + `BindingResult`.\n- UI displays field-level errors without losing entered form data.\n- Add tests for at least one invalid submission.'
          create_and_assign "[P1][M] Add first meaningful tests for \`TransactionController#home\`" "P1,size/M,type/tests" $'Acceptance criteria\n- Add tests covering:\n  - anonymous user → returns `"landing"`\n  - authenticated user → returns `"home"` and includes expected model keys (transactions, incomeList, totals, chart data)\n- Use Spring Security test support to simulate auth.'
          create_and_assign "[P1][M] Fix/clarify CSRF behavior for AJAX delete endpoints" "P1,size/M,type/bug,area/security,type/tests" $'Acceptance criteria\n- Deleting via `/transaction/delete/{id}` and `/income/delete/{id}` works reliably with Spring Security defaults.\n- Either:\n  - include CSRF token in fetch requests, OR\n  - explicitly configure CSRF (with justification in docs).\n- Add tests (preferred) or clear documentation explaining the choice.'
          create_and_assign "[P1][M] Improve CSV export: consistent quoting + file name includes date" "P1,size/M,type/feature" $'Acceptance criteria\n- CSV export correctly handles commas/quotes/newlines in description/title.\n- Response header sets a filename like `transactions-YYYY-MM.csv`.\n- Add at least one test validating output format for “special character” input.'

          create_and_assign "[P2][M] Introduce service layer for transactions/incomes (thin controllers)" "P2,size/M,type/refactor" $'Acceptance criteria\n- Create `TransactionService` and `IncomeService`.\n- Move “ownership checks” and CRUD logic out of controller.\n- Controller becomes request/response orchestration only.\n- Add unit tests for the services.'
          create_and_assign "[P2][M] Deduplicate monthly summary calculations (home + dashboard)" "P2,size/M,type/refactor" $'Acceptance criteria\n- Create a `CashflowSummaryService` that computes:\n  - monthly spending total\n  - monthly income total\n  - net cashflow\n  - category totals for charts\n- Both `home()` and `dashboard()` use the service.\n- Add tests for edge cases (null dates, empty lists).'
          create_and_assign "[P2][M] Replace “Month = now” with a \`PeriodStrategy\`" "P2,size/M,type/refactor,type/feature" $'Acceptance criteria\n- Add a clean way to compute summaries for different periods:\n  - current month (default)\n  - selected month via query param (e.g., `?month=2026-01`)\n- Use Strategy (or similar) rather than adding conditionals everywhere.\n- Tests cover at least 2 periods.'
          create_and_assign "[P2][M] Add \`@ControllerAdvice\` for consistent error handling" "P2,size/M,type/refactor" $'Acceptance criteria\n- Centralize common errors (not found, validation, generic exception).\n- Return a friendly error view for HTML routes and sensible responses for JSON endpoints.\n- Add tests for one HTML error and one JSON error.'
          create_and_assign "[P2][S] Make \`DataSeeder\` run only in dev profile" "P2,size/S,type/refactor" $'Acceptance criteria\n- DataSeeder does not run in tests or production-like runs.\n- Use `@Profile("dev")` or a config property.\n- Add a brief note in README: how to enable dev seeding.'
          create_and_assign "[P2][M] Enforce unique usernames + improve registration validation" "P2,size/M,type/feature,area/security,type/tests" $'Acceptance criteria\n- Username uniqueness enforced at DB level and in validation (friendly message).\n- Registration fails gracefully if username is taken.\n- Tests cover duplicate registration attempt.'
          create_and_assign "[P2][L] Replace \`double\` amounts with \`BigDecimal\` (money correctness)" "P2,size/L,type/refactor,type/tests,area/data" $'Acceptance criteria\n- Transaction.amount and Income.amount are BigDecimal.\n- All calculations updated (monthly totals, category totals, CSV export).\n- UI formatting updated (2 decimals).\n- Add tests showing rounding issues are gone.'
          create_and_assign "[P2][L] Introduce a shared base entity for \`Income\` and \`Transaction\`" "P2,size/L,type/refactor" $'Acceptance criteria\n- Create a @MappedSuperclass (or composition) to reduce duplicated fields (amount/date/description/user).\n- Keep JPA mapping clean.\n- No behavior changes; tests still pass.\n- Add at least one test validating mappings still work.'

          create_and_assign "[P3][M] Add filters: date range + category + text search" "P3,size/M,type/feature,area/ui" $'Acceptance criteria\n- Filter transactions by:\n  - start/end date\n  - category\n  - title/description contains\n- Filters apply to list + totals/charts (document the chosen behavior).\n- Tests for filter logic (service/repo level).'
          create_and_assign "[P3][M] Add pagination for transactions and incomes" "P3,size/M,type/feature" $'Acceptance criteria\n- Use Spring Data Pageable for lists.\n- UI shows page controls and page size selection.\n- Tests cover page boundaries and sorting.'
          create_and_assign "[P3][L] Implement monthly budgets per category" "P3,size/L,type/feature,area/data" $'Acceptance criteria\n- User can set a budget amount per category per month.\n- Dashboard shows remaining/over-budget per category.\n- Include data model changes + migrations approach documented.\n- Tests cover calculations and over-budget edge cases.'
          create_and_assign "[P3][L] Recurring income/expense rules" "P3,size/L,type/feature,area/data" $'Acceptance criteria\n- User can create a recurrence rule (weekly/monthly) for income or transaction.\n- System generates instances up to a horizon (e.g., next 3 months) without duplicates.\n- Add tests for month-end edge cases (e.g., Jan 31).'
          create_and_assign "[P3][L] CSV import with preview + validation report" "P3,size/L,type/feature,type/tests" $'Acceptance criteria\n- Upload CSV → show preview table → confirm import.\n- Validation errors reported per-row (missing date, bad amount, unknown category).\n- Tests cover importer parsing and validation.'
          create_and_assign "[P3][L] Split a transaction across multiple categories" "P3,size/L,type/feature,area/data" $'Acceptance criteria\n- One purchase can be split into line items with categories/amounts.\n- Totals and category chart reflect split lines.\n- UI supports adding/removing split lines.\n- Tests cover invariants (sum of splits == transaction total).'
          create_and_assign "[P3][M] Add “notes” field and display it everywhere relevant" "P3,size/M,type/feature" $'Acceptance criteria\n- Add notes to transaction and/or income.\n- Display notes in list/detail/edit and CSV export.\n- Migration plan documented.\n- Tests cover persistence and export.'
          create_and_assign "[P3][M/L] Add a small REST API (read-only) for transactions + incomes" "P3,size/M,type/feature" $'Acceptance criteria\n- Endpoints:\n  - GET /api/transactions\n  - GET /api/incomes\n- Response includes only the logged-in user’s data.\n- Add at least one contract/integration test.\nStretch: OpenAPI docs.'

          create_and_assign "[P4][L] Introduce Flyway migrations and stop using \`ddl-auto=update\`" "P4,size/L,type/devops,area/data" $'Acceptance criteria\n- Add Flyway + baseline migration(s) matching current schema.\n- Set ddl-auto=validate (or none) for non-dev profiles.\n- App boots clean on an empty DB.\n- Document how to reset/recreate DB in dev.'
          create_and_assign "[P4][M] Add Docker Compose for local run (app + Postgres) + docs" "P4,size/M,type/devops" $'Acceptance criteria\n- docker compose up brings up Postgres + app.\n- Uses environment variables (no secrets committed).\n- README includes one-command run instructions.'
          create_and_assign "[P4][M] Add CI pipeline with required checks (tests + formatting)" "P4,size/M,type/devops,type/tests" $'Acceptance criteria\n- GitHub Actions runs mvn test on PR.\n- Add at least one quality gate: Spotless/formatter OR Checkstyle OR SpotBugs.\n- README: how to run the same checks locally.'
          create_and_assign "[P4][M/L] Add Testcontainers-based integration tests for repositories" "P4,size/M,type/tests,type/devops" $'Acceptance criteria\n- Add integration tests that use Postgres Testcontainers for repositories and/or service layer.\n- CI runs them reliably.\n- Document expected runtime and how to run locally.'
          create_and_assign "[P4][M] Add structured logging + request correlation IDs + troubleshooting guide" "P4,size/M,type/devops" $'Acceptance criteria\n- Every request has a correlation ID (filter/interceptor).\n- Logs include safe user identifier, route, and correlation ID.\n- Add TROUBLESHOOTING.md with “how to collect logs and reproduce.”'
          create_and_assign "[P4][M] Harden Actuator usage (health/info + security)" "P4,size/M,type/devops,area/security" $'Acceptance criteria\n- Configure Actuator endpoints (at least health, info) with appropriate exposure.\n- Ensure endpoints are protected (or intentionally exposed with reasoning).\n- Add a custom health indicator for DB connectivity (or verify built-in behavior) and test it.'

          echo "Assigning milestones to ALL existing issues by [P#] prefix (reliable pass)..." >&2
          assign_all_existing_issues_to_milestones

          echo "Done." >&2
